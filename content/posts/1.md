---
title: "web서버와 DB서버 분리"
date: 2021-02-13T01:00:00+00:00
description: "Django server DB server 분리하기"
tags: ["Django","postgresql","hj_quiz"]
---

#### 목적
hj_quiz는 web과 DB가 한 서버 내에 존재 ☆
보안성, 확장성 등을 고려하여 DB서버를 분리하려고 합니다. 

#### DB 서버 외부 접속 허용
> 정보 OS: Ubuntu 20.10, DB: PostgreSQL 12.5
외부 접속 허용을 위해서는 2 파일을 수정해야 합니다.
2개 파일은 보통 /etc/postgresql/(version)/main(data)/ 경로에 존재합니다. (version등에 따라 다를 수 있음)
1. postgresql.conf
postgresql.conf 파일에서 IP 허용을 위해
listen_addresses = 'localhost'를 '*'로 수정해줍니다 
```bash
listen_addresses = '*'
```
2. pg_hba.conf 
pg_hba.conf 파일에서 127.0.0.1/32 로 되어 있는 설정 값을
0.0.0.0/0 또는 (접속허용IP/port)로 수정해 줍니다. 
```bash
host    all             all             0.0.0.0/0            md5
```
md5로 되어있는 METHOD의 경우는 여러가지 방식이 존재합니다.
trust, md5, reject, password 등등... 원하는 방식을 선택해주시면 됩니다.
md5의 경우는 md5로 암호화

설정이 끝난 후 postgres 재시작해줍니다
```bash
systemctl restart postgresql.service
```

> TEST
```bash
psql -h 1.1.1.1(DB server IP)
```
> 그러나... 되지 않았습니다.

#### 왜...?
설정 방법은 간단하여 금방 끝냈으나 해당 서버의 5432 port가 열린 것이 맞냐며 실패..
방화벽을 의심했는데 ssh로 접근이 되어 다른 문제인가  찾아봄.

#### 원인
알고보니 방화벽 문제가 맞았습니다.
```bash
sudo ufw status verbose
sudo ufw allow from xxx.xxx.xxx.xxx to any port 5432
```
UFW 값을 확인, 5432 port가 허용되어 있는지 확인 후 없을 경우 추가해줍니다. 
22 port default허용인 것인지 예전에 추가해놓은 것인지 ... TT 1시간 삽질...

